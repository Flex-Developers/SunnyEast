@page "/admin/orders"
@attribute [Authorize(Roles = "Administrator,Salesman")]

@using Application.Contract.Enums
@using Application.Contract.Order.Responses
@using Client.Components.Common
@using Client.Components.Dialogs
@using Client.Infrastructure.Services.Order
@using Microsoft.AspNetCore.Authorization
@using Severity = MudBlazor.Severity

@inject IOrderService OrderService
@inject ISnackbar Snackbar
@inject IDialogService Dialogs
@inject NavigationManager Navigation

<MudPaper Class="mx-auto mt-4 pa-4" MaxWidth="1280px">

    <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">
        Список заказов
    </MudText>

    <MudTable Items="_orders"
              Hover="true" Dense="true"
              Bordered="true" FixedHeader="true"
              Breakpoint="Breakpoint.Sm"
              Filter="FilterFunc"
              Class="border rounded-lg">

        <ToolBarContent>
            <MudTextField @bind-Value="_search"
                          Placeholder="Поиск по № заказа / магазину…"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          Class="w-100"/>
        </ToolBarContent>

        <HeaderContent>
            <MudTh Class="text-center" SortBy="OrderNumber">Номер заказа</MudTh>
            <MudTh Class="text-center" SortBy="ShopSlug">Магазин</MudTh>
            <MudTh Class="text-center" SortBy="Status">Статус</MudTh>
            <MudTh Class="text-center" SortBy="Sum">Сумма</MudTh>
            <MudTh Class="text-center" Style="width:275px">Действия</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>@context.OrderNumber</MudTd>
            <MudTd>@context.Shop!.Address</MudTd>
            <MudTd>
                <OrderStatusChip Status="@context.Status"/>
            </MudTd>
            <MudTd Class="text-right">@($"{context.Sum:N2} ₽")</MudTd>

            <MudTd Class="d-flex justify-center flex-wrap" Style="gap:8px; width:275px">
                @* кнопка «Подробнее» всегда доступна *@
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.Visibility"
                           @onclick="@(() => Navigation.NavigateTo($"/admin/orders/{context.Slug}"))">Подробнее
                </MudButton>


                @* остальные кнопки зависят от статуса *@
                @switch (context.Status)
                {
                    case OrderStatus.Submitted:
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Info" Size="Size.Small"
                                   @onclick="() => ChangeStatus(context, OrderStatus.Ready)">
                            Готов
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Error" Size="Size.Small"
                                   @onclick="() => AskCancel(context)">
                            Отменить
                        </MudButton>
                        break;

                    case OrderStatus.Ready:
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Success" Size="Size.Small"
                                   @onclick="() => ChangeStatus(context, OrderStatus.Issued)">
                            Выдать
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Error" Size="Size.Small"
                                   @onclick="() => AskCancel(context)">
                            Отменить
                        </MudButton>
                        break;
               
                }
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

@code {
    private List<OrderResponse> _orders = [];
    private string? _search;

    protected override async Task OnInitializedAsync()
        => _orders = await OrderService.GetAsync(string.Empty);

    /* ---------- поиск ---------- */
    private bool FilterFunc(OrderResponse o) =>
        string.IsNullOrWhiteSpace(_search)
        || o.OrderNumber.Contains(_search, StringComparison.OrdinalIgnoreCase)
        || o.Shop!.Slug.Contains(_search, StringComparison.OrdinalIgnoreCase);

    /* ---------- статус → RU ---------- */
    private static string ToRu(OrderStatus s) => s switch
    {
        OrderStatus.Submitted => "Оформлен",
        OrderStatus.Ready => "Готов",
        OrderStatus.Issued => "Выдан",
        OrderStatus.Canceled => "Отменён",
        _ => s.ToString()
    };

    /* ---------- изменение статуса ---------- */
    private async Task ChangeStatus(OrderResponse order,
        OrderStatus to,
        string? comment = null)
    {
        await OrderService.UpdateStatusAsync(order.Slug, to, comment);
        order.Status = to;
        Snackbar.Add($"Заказ {order.OrderNumber} → {ToRu(to)}", Severity.Success);
        StateHasChanged();
    }

    /* ---------- подтверждение отмены ---------- */
    private async Task AskCancel(OrderResponse order)
    {
        var dialogParameters = new DialogParameters { ["Content"] = $"{order.OrderNumber}" };
        var dialog = await Dialogs.ShowAsync<CancelConfirmation>("Отмена заказа", dialogParameters);
        if (!(await dialog.Result)!.Canceled)
            await ChangeStatus(order, OrderStatus.Canceled);
    }

}
