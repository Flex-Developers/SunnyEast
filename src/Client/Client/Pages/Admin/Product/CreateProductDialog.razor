@using Application.Contract.Product.Commands
@using Client.Infrastructure.Services.Category
@using Client.Infrastructure.Services.Product
@inject ICategoryService CategoryService
@inject IProductService ProductService
<MudForm Model="_command" @ref="_form">
    <MudDialog>
        <TitleContent>
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.Create" Class="mr-3 mb-n1"/>
                Добавить продукт
            </MudText>
        </TitleContent>
        <DialogContent>
            <MudTextField Label="Категория" Value="CategoryName" ReadOnly="true"/>
            <MudTextField Required="true" Label="Название" @bind-Value="_command.Name" InputType="InputType.Text" Clearable="true" AutoGrow="true"/>
            <MudTextField Required="true" Label="Цена" @bind-Value="_command.Price" Format="F1" Clearable="true"/>
            <MudTextField Label="Описание" @bind-Value="_command.Description" InputType="InputType.Text" Clearable="true" AutoGrow="true"/>

            <MudButton OnClick="ShowImageTable" StartIcon="@Icons.Material.Filled.Add">
                Добавить изображения
            </MudButton>

            @if (ShowTable)
            {
                @foreach (var image in _images.Select((value, index) => new { value, index }))
                {
                    <MudTr>
                        <MudTd>@(image.index + 1)</MudTd>
                        <MudTd>
                            <MudTextField @bind-Value="_images[image.index]" Label="Url изображения" InputType="InputType.Url" InputMode="InputMode.url" Clearable="true" AutoGrow="true"/>
                        </MudTd>
                    </MudTr>
                }

                <MudButton OnClick="SaveChanges" Color="Color.Primary" Variant="Variant.Filled">
                    Сохранить изменения
                </MudButton>
                <MudButton OnClick="CancelChanges" Color="Color.Error" Variant="Variant.Outlined">
                    Отменить изменения
                </MudButton>
            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="Cancel">Отмена</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateAsync">Создать</MudButton>
        </DialogActions>
    </MudDialog>
</MudForm>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] public string CategoryName { get; set; } = string.Empty;
    [Parameter] public Action OnSuccessfullyCreate { get; set; } = null!;
    private MudForm _form;

    private readonly CreateProductCommand _command = new()
    {
        Name = "",
        ProductCategorySlug = "",
        Price = null,
        Description = "",
    };

    private List<string> _images = new() { "", "", "", "", "", "", "", "", "", "" };
    private bool ShowTable = false;

    private void ShowImageTable()
    {
        ShowTable = true;
        StateHasChanged();
    }

    private void SaveChanges()
    {
        if (_images.All(string.IsNullOrEmpty)) // Если он все таки не добавил изображения
        {
            ShowTable = false;
            StateHasChanged();
            return;
        }

        ShowTable = false;
        _images = SortList(_images);
        _command.Images = _images.ToArray();

        Snackbar.Add("Изображения сохранены", Severity.Success);

        List<string> SortList(List<string> images)
        {
            // Сортирует список на случай если пользователь не введет данные подряд и оставит строки пустыми 
            for (int i = 0; i < images.Count; i++)
            {
                if (string.IsNullOrEmpty(images[i]))
                {
                    for (int j = i; j < images.Count; j++)
                    {
                        if (!string.IsNullOrEmpty(images[j]))
                        {
                            (images[j], images[i]) = (images[i], images[j]);
                            j = images.Count;
                        }
                    }
                }
            }

            return images;
        }
    }

    private void CancelChanges()
    {
        if (_command.Images != null && _command.Images.Length > 0)
            _images = _command.Images.ToList();
        else
        {
            if (_command.Images is null)
                _images = new() { "", "", "", "", "", "", "", "", "", "" };
            else
                _images = _command.Images.ToList();
        }

        ShowTable = false;
    }

    private void Cancel()
    {
        MudDialog.Cancel();
        MudDialog.Close();
    }

    private async Task CreateAsync()
    {
        await _form.Validate();

        if (_form.IsValid)
        {
            _command.ProductCategorySlug = (await CategoryService.GetByName(CategoryName))!.Slug;
            _command.Images = _images.Where(i => !string.IsNullOrEmpty(i)).ToArray(); // Избавляемся от пустых ссылок

            var success = await ProductService.Post(_command);
            if (success)
            {
                Snackbar.Add("Продукт успешно создан!", Severity.Success);
                MudDialog.Close();
                OnSuccessfullyCreate?.Invoke();
            }
        }
        else
        {
            Snackbar.Add("Пожалуйста, заполните все обязательные поля.", Severity.Warning);
        }
    }

}