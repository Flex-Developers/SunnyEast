@page "/cart"
@using Client.Infrastructure.Services.Cart
@using Client.Infrastructure.Services.Cart.Models
@inject ICartService CartService
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">

    <!-- 1️  Заголовок --------------------------------------------------->
    <MudText Typo="Typo.h3" Align="Align.Center" Class="mb-4">Корзина</MudText>

    <!-- 2️  Таблица товаров ------------------------------------------->
    <MudPaper Class="p-4">

        @if (_items.Count == 0)
        {
            <MudText Align="Align.Center" Typo="Typo.h6">Корзина пуста</MudText>
        }
        else
        {
            <MudTable Items="_items"
                      Hover="true"
                      Elevation="0"
                      Class="cart-table"
                      Breakpoint="Breakpoint.Sm">

                <HeaderContent>
                    <MudTh></MudTh>
                    <MudTh>Продукт</MudTh>
                    <MudTh>Объём</MudTh>
                    <MudTh Class="text-center">Кол-во</MudTh>
                    <MudTh Class="text-right">Цена</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd>
                        <MudImage Src="@context.ImageUrl"
                                  Alt="@context.ProductName"
                                  Width="90" Height="90"
                                  Class="rounded object-cover" />
                    </MudTd>

                    <MudTd DataLabel="Продукт">
                        <MudText Typo="Typo.subtitle1" Class="name-ellipsis">
                            @context.ProductName
                        </MudText>
                    </MudTd>

                    <MudTd DataLabel="Объём">
                        <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined">
                            @context.SelectedVolume
                        </MudChip>
                    </MudTd>

                    <MudTd DataLabel="Кол-во" Class="text-center">
                        <MudText Typo="Typo.h6">@context.Quantity</MudText>
                    </MudTd>

                    <MudTd DataLabel="Цена" Class="text-right">
                        <MudText Typo="Typo.subtitle1">
                            @((context.DiscountPrice ?? context.Price) * context.Quantity) ₽
                        </MudText>
                    </MudTd>

                    <MudTd DataLabel="">
                        <!-- десктоп/планшет -->
                        <MudHidden Breakpoint="Breakpoint.SmAndDown">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           OnClick="@(() => RemoveItem(context))" />
                        </MudHidden>

                        <!-- мобильный -->
                        <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">
                            <MudButton Color="Color.Error"
                                       Variant="Variant.Outlined"
                                       FullWidth="true"
                                       Class="delete-mobile"
                                       StartIcon="@Icons.Material.Filled.Delete"
                                       OnClick="@(() => RemoveItem(context))">
                                Удалить
                            </MudButton>
                        </MudHidden>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>

    @if (_items.Count != 0)
    {
        <!-- 3️  Сводка заказа --------------------------------------------->
        <MudPaper Class="p-4 mt-4 mx-auto" Style="max-width: 700px;">
            <MudText Typo="Typo.h5" Class="mb-3">Сводка заказа</MudText>

            <div class="d-flex justify-space-between mb-2 cart-summary">
                <span>Товаров:</span>
                <span>@_items.Sum(i => i.Quantity)</span>
            </div>

            <div class="d-flex justify-space-between mb-2 cart-summary">
                <span>Сумма:</span>
                <span>@_total ₽</span>
            </div>

            <MudDivider Class="my-3"/>

            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       FullWidth="true" Size="Size.Large"
                       Disabled="@(_items.Count == 0)">
                Перейти к оформлению
            </MudButton>
        </MudPaper>
    }

</MudContainer>

@code {
    private List<CartItemDto> _items = new();
    private decimal _total;

    protected override async Task OnInitializedAsync()
    {
        CartService.OnChange += CartChanged;
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        var cart = await CartService.GetCartAsync();
        _items = cart?.Orders ?? [];
        CalculateTotal();
    }

    private void CalculateTotal() =>
        _total = _items.Sum(i => i.Quantity * (i.DiscountPrice ?? i.Price));

    private async Task RemoveItem(CartItemDto item)
    {
        await CartService.RemoveOrderAsync(item.ProductSlug, item.SelectedVolume);
        _items.Remove(item);
        CalculateTotal();
    }

    private async void CartChanged()
    {
        await LoadAsync();
        StateHasChanged();
    }

    public void Dispose() => CartService.OnChange -= CartChanged;
}

<style>
.cart-table th,
.cart-table td           { font-size: 1.12rem; padding: 15px 12px; }
.cart-summary span       { font-size: 1.12rem; }
.object-cover            { object-fit: cover; }
.name-ellipsis {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

@@media (max-width: 600px) {

    .cart-table td            { padding: 10px 0; font-size: 1rem; }
    .cart-summary span        { font-size: 1rem; }

    .cart-table td[data-label='Кол-во'],
    .cart-table td[data-label='Цена'] {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .delete-mobile            { margin-top: 6px; }
}
</style>
