@page "/Register"
@using Application.Contract.User.Commands
@using Client.Infrastructure.Services.Auth
@using Severity = MudBlazor.Severity
@inject IAuthService AuthService
@inject ISnackbar Snackbar


<MudContainer Class="register-container ">
    <MudPaper Class="register-paper rounded pa-4 shadow-md" Elevation="3" @onkeyup="OnKeyUpHandler">

        <MudForm Model="_user" @ref="_form" Validation="@(_userValidator.ValidateValue)" ValidationDelay="0"
                 Class="register-form d-flex flex-column gap-0">
            <MudCardHeader Class="text-center justify-center align-center">
                <MudText Typo="Typo.h4" Align="Align.Center" Class="centered-text">Регистрация</MudText>
            </MudCardHeader>

            <MudTextField @bind-Value="_user.Name"
                          Label="Имя"
                          For="() => _user.Name"
                          Variant="Variant.Outlined"
                          Immediate="true"
                          OnKeyUp="OnKeyUpHandler"/>

            <MudTextField @bind-Value="_user.Surname"
                          Label="Фамилия"
                          For="() => _user.Surname"
                          Variant="Variant.Outlined"
                          Immediate="true"
                          OnKeyUp="OnKeyUpHandler"/>
            <MudTextField T="string"
                          ValueChanged="@(value => PhoneNumberChanged(value))"
                          OnBlur="CheckPhoneAndEmail"
                          OnKeyUp="OnKeyUpHandler"
                          Error="isPhoneAndEmailEmpty"
                          ErrorText="@_requiredErrorMessage"
                          Immediate="true"
                          Label="Номер телефона"
                          For="() => _user.PhoneNumber!"
                          Variant="Variant.Outlined"
                          Mask="@(new PatternMask("000-000-00-00"))"
                          Adornment="Adornment.Start"
                          AdornmentText="+7"/>

            <MudTextField T="string"
                          ValueChanged="@(value => EmailChanged(value))"
                          OnBlur="CheckPhoneAndEmail"
                          OnKeyUp="OnKeyUpHandler"
                          Error="isPhoneAndEmailEmpty"
                          ErrorText="@_requiredErrorMessage"
                          Immediate="true"
                          Label="Электронная почта"
                          For="() => _user.Email!"
                          Variant="Variant.Outlined"
                          Mask="RegexMask.Email()"/>

            <MudTextField @bind-Value="_user.Password"
                          Label="Пароль"
                          For="@(() => _user.Password)"
                          Variant="Variant.Outlined"
                          InputType="@_passwordInput"
                          OnKeyUp="OnKeyUpHandler"
                          Adornment="Adornment.End"
                          AdornmentIcon="@_passwordInputIcon"
                          OnAdornmentClick="ShowOrHidePassword"/>

            <MudTextField @bind-Value="_user.ConfirmPassword"
                          Label="Подтвердите пароль"
                          For="@(() => _user.ConfirmPassword)"
                          Variant="Variant.Outlined"
                          InputType="@_passwordInput"
                          OnKeyUp="OnKeyUpHandler"
                          Adornment="Adornment.End"
                          AdornmentIcon="@_passwordInputIcon"
                          OnAdornmentClick="ShowOrHidePassword"/>

            <MudCheckBox @bind-Value="_agreeForPersonalDataProcessing"
                         Label="Согласен с обработкой данных."
                         Style="margin-left: -13px"
                         Color="Color.Primary">
            </MudCheckBox>

            <MudButton Variant="Variant.Filled"
                       Disabled="!_agreeForPersonalDataProcessing"
                       Color="Color.Primary"
                       Class="register-button"
                       @onclick="SubmitRegister">
                Зарегистрироваться
            </MudButton>

            <MudCardActions Class="d-flex flex-column align-center">
                <MudText Typo="Typo.body2" Style="padding-top: 20px">Уже регистрировались?</MudText>
                <MudLink Style="padding-top: 10px; margin-bottom: -10px" Class="text-primary" OnClick="@Login">
                    Войти
                </MudLink>
            </MudCardActions>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {

    private MudForm _form = null!;
    private bool _isPasswordVisible;
    private bool _agreeForPersonalDataProcessing;
    private bool _isSubmitting; // NEW: защита от повторного сабмита
    private InputType _passwordInput = InputType.Password;
    private string _passwordInputIcon = Icons.Material.Filled.VisibilityOff;
    private RegisterUserValidator _userValidator = new RegisterUserValidator();
    private bool isPhoneAndEmailEmpty;
    private string _requiredErrorMessage = "Номер телефона или почта должны быть заполнены.";

    protected void CheckPhoneAndEmail()
    {
        isPhoneAndEmailEmpty = string.IsNullOrWhiteSpace(_user.PhoneNumber) && string.IsNullOrWhiteSpace(_user.Email);
        StateHasChanged();
    }

    private void PhoneNumberChanged(string phone)
    {
        _user.PhoneNumber = phone;
        isPhoneAndEmailEmpty = string.IsNullOrWhiteSpace(_user.PhoneNumber) && string.IsNullOrWhiteSpace(_user.Email);
    }

    private void EmailChanged(string email)
    {
        _user.Email = email;
        isPhoneAndEmailEmpty = string.IsNullOrWhiteSpace(_user.PhoneNumber) && string.IsNullOrWhiteSpace(_user.Email);
    }

    RegisterUserCommand _user = new()
    {
        Name = "",
        Surname = "",
        PhoneNumber = "",
        Email = "",
        Password = "",
        ConfirmPassword = ""
    };

    private void ShowOrHidePassword()
    {
        if (_isPasswordVisible)
        {
            _isPasswordVisible = false;
            _passwordInputIcon = Icons.Material.Filled.VisibilityOff;
            _passwordInput = InputType.Password;
        }
        else
        {
            _isPasswordVisible = true;
            _passwordInputIcon = Icons.Material.Filled.Visibility;
            _passwordInput = InputType.Text;
        }
    }
    
    private static string MaskPhone(string? phone)
    {
        var digits = new string((phone ?? string.Empty).Where(char.IsDigit).ToArray()); // "1234567890"
        if (digits.Length < 10)
            return "+7-***-***-**-**";

        // показываем только последние 4 цифры (две пары)
        var last2a = digits[^4..^2]; // предпоследние 2 цифры
        var last2b = digits[^2..];   // последние 2 цифры

        return $"+7-***-***-{last2a}-{last2b}";
    }


    private static string MaskEmail(string? email)
    {
        if (string.IsNullOrWhiteSpace(email))
            return "";
        
        var at = email.IndexOf('@');
        
        if (at <= 1) 
            return $"***{email.Substring(at)}";
        
        return $"{new string(email.Take(3).ToArray())}***{email.Substring(at)}";
    }


    private async Task SubmitRegister()
    {
        try
        {
            await _form.Validate();
            CheckPhoneAndEmail();

            if (_form.IsValid && isPhoneAndEmailEmpty == false)
            {
                if (await AuthService.RegisterAsync(_user))
                {
                    // --- Переходим на страницу подтверждения кода (UI-демо) ---
                    var channel = string.IsNullOrWhiteSpace(_user.Email) ? "телефон" : "e-mail";
                    var destination = string.IsNullOrWhiteSpace(_user.Email) ? MaskPhone(_user.PhoneNumber) : MaskEmail(_user.Email);
                    var title = Uri.EscapeDataString("Подтверждение регистрации");
                    var returnUrl = Uri.EscapeDataString("/");

                    var to = Uri.EscapeDataString(destination);
                    Navigation.NavigateTo($"/verify?purpose=register&channel={channel}&to={to}&title={title}&len=6&returnUrl={returnUrl}");
                }
                else
                {
                    Snackbar.Add("Ошибка регистрации, Проверьте введенные данные, или попробуйте позже.", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("Правильно заполните данные!", Severity.Warning);
            }
        }
        catch (Exception exception)
        {
            Snackbar.Add(exception.Message, Severity.Error);
        }
    }

    // NEW: единый обработчик Enter для всех полей формы
    private async Task OnKeyUpHandler(KeyboardEventArgs e)
    {
        if (_isSubmitting)
            return;

        // Триггерим только чистый Enter (включая NumpadEnter), без модификаторов
        if (e is not null &&
            (e.Key == "Enter" || e.Code == "Enter" || e.Key == "NumpadEnter") &&
            !e.ShiftKey && !e.CtrlKey && !e.AltKey && !e.MetaKey)
        {
            // Уважим бизнес-правило: без согласия — не сабмитим
            if (!_agreeForPersonalDataProcessing)
            {
                Snackbar.Add("Подтвердите согласие на обработку данных.", Severity.Warning);
                return;
            }

            try
            {
                _isSubmitting = true;
                // На OnKeyUp биндинг уже завершился, это безопасный момент для сабмита
                await SubmitRegister();
            }
            finally
            {
                _isSubmitting = false;
            }
        }
    }

    private void Login()
    {
        Navigation.NavigateTo("/login");
    }

    public class RegisterUserValidator : AbstractValidator<RegisterUserCommand>
    {
        public RegisterUserValidator()
        {
            RuleFor(x => x.Name)
                .NotEmpty().WithMessage("Имя обязательно.")
                .Matches(@"^[a-zA-Zа-яА-Я]+$").WithMessage("Имя может содержать только буквы.");

            RuleFor(x => x.Surname)
                .Matches(@"^[a-zA-Zа-яА-Я]+$").WithMessage("Фамилия может содержать только буквы.")
                .When(x => !string.IsNullOrWhiteSpace(x.Surname));

            RuleFor(x => x.PhoneNumber)
                .Matches(@"^\d{3}-\d{3}-\d{2}-\d{2}$")
                .WithMessage("Некорректный формат номера телефона.")
                .When(x => !string.IsNullOrWhiteSpace(x.PhoneNumber));

            RuleFor(x => x.Email)
                .EmailAddress()
                .WithMessage("Некорректный формат электронной почты.")
                .When(x => !string.IsNullOrWhiteSpace(x.Email));

            RuleFor(x => x.Password)
                .NotEmpty().WithMessage("Пароль обязателен.")
                .MinimumLength(8).WithMessage("Пароль должен содержать минимум 8 символов.")
                .Matches(@"[A-Z]").WithMessage("Пароль должен содержать минимум одну заглавную букву.")
                .Matches(@"[a-z]").WithMessage("Пароль должен содержать минимум одну строчную букву.")
                .Matches(@"\d").WithMessage("Пароль должен содержать минимум одну цифру.");

            RuleFor(x => x.ConfirmPassword)
                .NotEmpty().WithMessage("Подтверждение пароля обязательно.")
                .Equal(x => x.Password).WithMessage("Пароли должны совпадать.");
        }

        public Func<object, string, Task<IEnumerable<string>>> ValidateValue => async (model, propertyName) =>
        {
            var result = await ValidateAsync(ValidationContext<RegisterUserCommand>.CreateWithOptions((RegisterUserCommand)model, x => x.IncludeProperties(propertyName)));
            if (result.IsValid)
                return [];
            return result.Errors.Select(e => e.ErrorMessage);
        };
    }

}

<style>
    .register-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 90vh;
    }

    .register-paper {
        width: 400px;
        padding: 20px;
    }

    .register-form {
        display: flex;
        flex-direction: column;
    }

    .register-button {
        margin-top: 5px;
    }

    .centered-text {
        text-align: center;
    }
</style>
