@page "/verify"
@using Application.Contract.User.Commands
@using Application.Contract.Verification.Responses
@using Client.Infrastructure.Services.Account
@using Client.Infrastructure.Services.Auth
@using Client.Infrastructure.Services.Verification
@using Client.Infrastructure.Services.Verification.Register
@using Severity = MudBlazor.Severity

@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject IRegistrationDraftService DraftService
@inject IVerificationClient VerificationClient
@inject IAuthService AuthService
@inject IAccountService AccountService

@implements IDisposable

<PageTitle>Подтверждение кода</PageTitle>

<div class="verify-wrapper">
    <MudContainer Gutters="false" MaxWidth="MaxWidth.False" Class="verify-container">
        <MudPaper Class="@($"verify-card {(_showSuccess ? "success" : string.Empty)}")"
                  Elevation="8"
                  Square="false"
                  @onkeyup="OnKeyUpAsync">

            @if (!_showSuccess)
            {
                <div class="card-header">
                    <div class="icon-wrapper">
                        <MudIcon Icon="@Icons.Material.Filled.Shield" Size="Size.Large"/>
                    </div>
                    <MudText Typo="Typo.h4" Class="title">@_title</MudText>

                    @if (!_isExpired)
                    {
                        <MudText Typo="Typo.body1" Class="subtitle">Мы отправили код подтверждения на</MudText>
                        <span class="destination">@(_destination ?? _channel)</span>
                    }
                </div>

                <div class="code-input-container">
                    <div class="code-inputs" style="--digits:@_codeLength" @ref="_codeInputsRef">
                        @for (int i = 0; i < _codeLength; i++)
                        {
                            var index = i;
                            <input type="text"
                                   inputmode="numeric"
                                   pattern="[0-9]*"
                                   autocomplete="one-time-code"
                                   maxlength="1"
                                   class="code-input @(_codeValues[index].Length > 0 ? "filled" : "")"
                                   value="@_codeValues[index]"
                                   @oninput="@(e => OnCodeInputAsync(index, e.Value?.ToString() ?? ""))"
                                   @onkeydown="@(e => OnKeyDownAsync(index, e))"
                                   @onkeyup="@(e => OnKeyUpAsync(e))"
                                   @onpaste="@(async e => await OnPasteAsync(e))"
                                   @onfocus="@(async () => await OnFocusAsync(index))"
                                   placeholder="·"
                                   id="@($"code-input-{index}")"
                                   disabled="@(!CanInteract)"/>
                        }
                    </div>

                    @if (_isSubmitting)
                    {
                        <div class="loading-overlay">
                            <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true"/>
                        </div>
                    }
                </div>

                <div class="actions">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               Size="Size.Large"
                               Disabled="@(!CanSubmit)"
                               OnClick="SubmitCodeAsync"
                               Class="submit-button">
                        @if (_isSubmitting)
                        {
                            <span>Проверяем...</span>
                        }
                        else
                        {
                            <span>Подтвердить</span>
                        }
                    </MudButton>

                    <div class="resend-section">
                        @if (_resendBlockedForToday)
                        {
                            <MudText Typo="Typo.body2" Class="resend-timer">Повторная отправка недоступна сегодня.
                            </MudText>
                        }
                        else if (_canResend)
                        {
                            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ResendCodeAsync"
                                       Class="resend-button">
                                Отправить код повторно
                            </MudButton>
                        }
                        else if (_isExpired)
                        {
                            <MudText Typo="Typo.body2" Class="resend-timer">Сессия истекла.</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="resend-timer">
                                Повторная отправка через @_resendTimer сек
                            </MudText>
                        }
                    </div>


                    <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="Cancel" Class="cancel-button">
                        Отмена
                    </MudButton>
                </div>
            }
            else
            {
                <div class="success-content">
                    <div class="success-icon">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle"/>
                    </div>
                    <MudText Typo="Typo.h5" Class="success-title">Успешно!</MudText>
                    <MudText Typo="Typo.body1" Class="success-message">Код подтвержден. Перенаправляем вас...</MudText>
                </div>
            }
        </MudPaper>
    </MudContainer>
</div>

@code
{
    // ======== Константы текстов ========
    private const string MsgSessionNotFound = "Сессия не найдена или уже завершена. Начните заново.";
    private const string MsgSessionExpired = "Сессия истекла. Запросите новый код.";
    private const string MsgAttemptsExhausted = "Исчерпаны попытки. Начните заново.";
    private const string MsgInvalidCode = "Неверный код.";
    private const string MsgWelcome = "Вы вошли в систему. Добро пожаловать!";
    private const string MsgResent = "Код отправлен повторно";

    // ======== Параметры из query ========
    private string _title = "Подтвердите код";
    private string _channel = "e-mail";
    private string? _destination;
    private string _purpose = "register";
    private int _codeLength = 4;
    private string _returnUrl = "/";
    private string _sessionId = "";

    // ======== Состояние сессии ========
    private int _ttl;
    private int _attemptsLeft;
    private bool _isExpired;
    private bool _sessionLoaded;

    // ======== UI состояние ========
    private string[] _codeValues = [];
    private bool _isSubmitting;
    private bool _showSuccess;

    // флаги для resend
    private bool _resending;
    private bool _resendBlockedForToday;
    private bool _canResend;
    private int _resendTimer;
    private Timer? _tick;

    private ElementReference _codeInputsRef;

    // ======== Вычисляемые свойства ========
    private bool IsCodeComplete => _codeValues.All(v => v is { Length: 1 } && char.IsDigit(v[0]));
    private bool CanInteract => !_isSubmitting && !_resending && !_isExpired && _sessionLoaded;
    private bool CanSubmit => IsCodeComplete && CanInteract;

    // ======== Жизненный цикл ========
    protected override void OnInitialized()
    {
        ReadQueryParameters();
        InitCodeArray();
        _resendTimer = 60; // стартовое ожидание до загрузки состояния
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await Task.Delay(300);
        await FocusInputAsync(0);
        await LoadStateAsync();
    }

    // ======== Инициализация ========
    private void ReadQueryParameters()
    {
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        _purpose = query["purpose"] ?? _purpose;
        _channel = query["channel"] ?? _channel;
        _destination = query["to"];
        _sessionId = query["sid"] ?? "";

        _title = query["title"] ?? _purpose switch
        {
            "register" => "Подтверждение регистрации",
            "login" => "Подтверждение входа",
            "reset" => "Подтверждение сброса пароля",
            _ => "Подтвердите код"
        };

        _returnUrl = query["returnUrl"] ?? "/";

        if (int.TryParse(query["len"], out var len) && len is >= 4 and <= 8)
            _codeLength = len;
    }

    private void InitCodeArray()
    {
        _codeValues = new string[_codeLength];
        for (int i = 0; i < _codeLength; i++) _codeValues[i] = "";
    }

    private async Task LoadStateAsync()
    {
        try
        {
            var s = await VerificationClient.GetStateAsync(_sessionId);
            _sessionLoaded = true;

            _ttl = s.TtlSeconds;
            _attemptsLeft = s.AttemptsLeft;
            _canResend = s.CooldownSeconds <= 0 && !_resendBlockedForToday;
            _resendTimer = s.CooldownSeconds;

            _destination ??= s.MaskedPhone ?? s.MaskedEmail;

            StartTick();
            StateHasChanged();
        }
        catch
        {
            _isExpired = true;
            _canResend = false;
            ShowSnack(MsgSessionNotFound, Severity.Error);
        }
    }

    // ======== Таймер ========
    private void StartTick()
    {
        StopTick();

        _tick = new Timer(_ =>
        {
            var changed = false;

            if (_ttl > 0)
            {
                _ttl--;
                changed = true;
            }

            if (_resendTimer > 0)
            {
                _resendTimer--;
                changed = true;
            }

            if (_ttl <= 0 && !_isExpired)
            {
                _isExpired = true;
                _canResend = false;
                changed = true;
            }

            if (_resendTimer <= 0 && !_canResend && !_isExpired && !_resendBlockedForToday)
            {
                _canResend = true;
                changed = true;
            }

            if (changed) InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private void StopTick()
    {
        _tick?.Dispose();
        _tick = null;
    }

    // ======== Обработчики инпутов ========
    private async Task OnCodeInputAsync(int index, string value)
    {
        var last = (value ?? string.Empty).Trim().LastOrDefault();
        if (last == default || !char.IsDigit(last))
        {
            _codeValues[index] = "";
            StateHasChanged();
            return;
        }

        _codeValues[index] = last.ToString();

        if (index < _codeLength - 1)
            await FocusInputAsync(index + 1);
    }

    private async Task OnKeyDownAsync(int index, KeyboardEventArgs e)
    {
        if (e.Key == "Backspace" && string.IsNullOrEmpty(_codeValues[index]) && index > 0)
        {
            _codeValues[index - 1] = "";
            await FocusInputAsync(index - 1);
        }
        else if (e.Key == "ArrowLeft" && index > 0)
        {
            await FocusInputAsync(index - 1);
        }
        else if (e.Key == "ArrowRight" && index < _codeLength - 1)
        {
            await FocusInputAsync(index + 1);
        }
    }

    private async Task OnKeyUpAsync(KeyboardEventArgs e)
    {
        if (_isSubmitting) return;

        var isPlainEnter = e is not null
                           && (e.Key is "Enter" or "NumpadEnter" || e.Code == "Enter")
                           && !e.ShiftKey && !e.CtrlKey && !e.AltKey && !e.MetaKey;

        if (isPlainEnter)
            await SubmitCodeAsync();
    }

    private async Task OnPasteAsync(ClipboardEventArgs _)
    {
        var pastedText = await JSRuntime.InvokeAsync<string>("eval", "navigator.clipboard.readText()");
        if (!string.IsNullOrEmpty(pastedText))
            await HandlePastedCodeAsync(pastedText);
    }

    private async Task HandlePastedCodeAsync(string pastedText)
    {
        var cleanCode = new string((pastedText ?? string.Empty).Where(char.IsDigit).ToArray());

        for (int i = 0; i < Math.Min(cleanCode.Length, _codeLength); i++)
            _codeValues[i] = cleanCode[i].ToString();

        var firstEmpty = Array.FindIndex(_codeValues, v => string.IsNullOrEmpty(v));
        var focusIndex = firstEmpty >= 0 ? firstEmpty : _codeLength - 1;

        await FocusInputAsync(focusIndex);
        StateHasChanged();
    }

    private async Task OnFocusAsync(int index)
    {
        await Task.Delay(50);
        await JSRuntime.InvokeVoidAsync("eval",
            $"document.getElementById('code-input-{index}')?.scrollIntoView({{ behavior:'smooth', block:'center', inline:'center' }})");
    }

    private Task FocusInputAsync(int index)
        => JSRuntime.InvokeVoidAsync("eval", $"document.getElementById('code-input-{index}')?.focus()").AsTask();

    private void ResetInputs()
    {
        for (int i = 0; i < _codeLength; i++) _codeValues[i] = "";
    }

    // ======== Сабмит ========
    private async Task SubmitCodeAsync()
    {
        if (!CanSubmit) return;

        _isSubmitting = true;

        try
        {
            // обновим состояние с сервера перед верификацией
            if (!await RefreshStateAsync()) return;

            var code = string.Join("", _codeValues);
            var verify = await TryVerifyAsync(_sessionId, code);

            if (verify is null || !verify.Success)
            {
                await HandleVerifyFailureAsync();
                return;
            }

            if (_purpose == "register")
            {
                var publicPart = await DraftService.GetPublicAsync();
                var (pwd, confirm) = DraftService.GetPassword();

                if (publicPart is null || string.IsNullOrEmpty(pwd) || string.IsNullOrEmpty(confirm))
                {
                    ShowSnack("Сессия регистрации не найдена. Начните заново.", Severity.Error);
                    Navigation.NavigateTo("/register");
                    return;
                }

                if (!await RegisterAsync(publicPart, pwd, confirm))
                    throw new Exception("Ошибка регистрации.");

                var loginOk = await LoginAsync(publicPart, pwd);
                if (loginOk)
                {
                    await DraftService.ClearAllAsync();
                    await ShowSuccessAndNavigateAsync();
                }
                else
                {
                    await DraftService.ClearPublicAsync();

                    ShowSnack("Регистрация выполнена, но войти не удалось. Введите пароль вручную.", Severity.Warning);
                    Navigation.NavigateTo($"/login?returnUrl={Uri.EscapeDataString(_returnUrl)}", forceLoad: false);
                    return;
                }
            }
            else if (_purpose == "reset")
            {
                await ShowSuccessAndNavigateAsync(); // вернёт на returnUrl
            }
            else if (_purpose == "link")
            {
                // 1) говорим серверу «код подтверждён, можно привязывать»
                var linked = await AccountService.ConfirmLinkAsync(_sessionId);
                if (!linked)
                    throw new Exception("Сервер не подтвердил привязку контакта.");

                // 2) обновляем клеймы (e-mail/телефон) тихо, без выхода из сессии
                await AccountService.RefreshTokenAsync();

                await ShowSuccessAndNavigateAsync(); // вернёт на returnUrl ( /account )
            }
        }
        catch (Exception ex)
        {
            ShowSnack(ex.Message, Severity.Error);
            ResetInputs();
            await FocusInputAsync(0);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task<bool> RefreshStateAsync()
    {
        var st = await VerificationClient.GetStateAsync(_sessionId);
        _ttl = st.TtlSeconds;
        _attemptsLeft = st.AttemptsLeft;

        if (_ttl <= 0)
        {
            _isExpired = true;
            ShowSnack(MsgSessionExpired, Severity.Warning);
            return false;
        }

        if (_attemptsLeft <= 0)
        {
            ShowSnack(MsgAttemptsExhausted, Severity.Error);
            return false;
        }

        return true;
    }

    private async Task<VerifyResponse?> TryVerifyAsync(string sessionId, string code)
    {
        try
        {
            return await VerificationClient.VerifyAsync(sessionId, code);
        }
        catch (Exception httpEx)
        {
            ShowSnack(httpEx.Message, Severity.Error);
            return null;
        }
    }

    private async Task HandleVerifyFailureAsync()
    {
        ShowSnack(MsgInvalidCode, Severity.Error);
        try
        {
            var st2 = await VerificationClient.GetStateAsync(_sessionId);
            _attemptsLeft = st2.AttemptsLeft;
            _ttl = st2.TtlSeconds;
            if (_ttl <= 0)
            {
                _isExpired = true;
                _canResend = false;
            }
        }
        catch
        {
            /* ignore */
        }

        ResetInputs();
        await FocusInputAsync(0);
    }

    private Task<bool> RegisterAsync(RegisterUserCommand publicPart, string pwd, string confirm)
    {
        var cmd = new RegisterUserCommand
        {
            Name = publicPart.Name,
            Surname = publicPart.Surname,
            Email = string.IsNullOrWhiteSpace(publicPart.Email) ? null : publicPart.Email,
            PhoneNumber = string.IsNullOrWhiteSpace(publicPart.PhoneNumber) ? null : $"+7-{publicPart.PhoneNumber}",
            Password = pwd,
            ConfirmPassword = confirm
        };

        return AuthService.RegisterAsync(cmd);
    }


    private Task<bool> LoginAsync(RegisterUserCommand publicPart, string pwd)
    {
        var login = new LoginUserCommand
        {
            Email = publicPart.Email ?? "",
            PhoneNumber = string.IsNullOrWhiteSpace(publicPart.PhoneNumber) ? "" : $"+7-{publicPart.PhoneNumber}",
            Password = pwd
        };
        return AuthService.LoginAsync(login, _returnUrl, false);
    }
    
    private async Task ShowSuccessAndNavigateAsync()
    {
        _showSuccess = true;
        StateHasChanged();

        await Task.Delay(1200);

        var msg = _purpose switch
        {
            "register" => "Регистрация подтверждена.",
            "login" => "Вход подтверждён.",
            "reset" => "Код подтверждён. Введите новый пароль.",
            "link" => "Контакт подтверждён.",
            _ => "Готово."
        };

        ShowSnack(msg, Severity.Success);
        Navigation.NavigateTo(_returnUrl);
    }


    // ======== Повторная отправка ========
    private async Task ResendCodeAsync()
    {
        if (!_canResend || _isExpired || string.IsNullOrWhiteSpace(_sessionId) || _resending)
            return;

        _resending = true;
        _canResend = false; // блокируем мгновенно
        StateHasChanged();

        try
        {
            // 1) перед отправкой синхронизируемся с сервером
            GetSessionStateResponse? st;
            try
            {
                st = await VerificationClient.GetStateAsync(_sessionId);
            }
            catch (Exception ex)
            {
                ShowSnack(ex.Message, Severity.Error);
                _isExpired = true;
                return;
            }

            if (st is null)
            {
                ShowSnack("Сессия не найдена.", Severity.Error);
                _isExpired = true;
                return;
            }

            if (st.TtlSeconds <= 0)
            {
                _isExpired = true;
                ShowSnack("Сессия истекла. Начните заново.", Severity.Warning);
                return;
            }

            if (st.CooldownSeconds > 0)
            {
                _resendTimer = st.CooldownSeconds;
                _canResend = false;
                return;
            }

            ResendResponse? r = null;
            try
            {
                r = await VerificationClient.ResendAsync(_sessionId);
            }
            catch (Exception ex)
            {
                var msg = ex.Message ?? string.Empty;

                if (msg.Contains("доступна позднее", StringComparison.OrdinalIgnoreCase))
                {
                    await RefreshResendStateFromServerSafe();
                }
                else if (msg.Contains("Превышен дневной лимит", StringComparison.OrdinalIgnoreCase))
                {
                    _resendBlockedForToday = true;
                    _resendTimer = 0;
                    _canResend = false;
                    ShowSnack("Превышен дневной лимит отправки SMS. Попробуйте завтра.", Severity.Warning);
                }
                else
                {
                    ShowSnack($"Ошибка при отправке кода: {msg}", Severity.Error);
                    await RefreshResendStateFromServerSafe();
                }

                return; // обязательно: после ошибки выходим
            }

            // доп. защита от неожиданного null (на всякий случай)
            if (r is null)
            {
                await RefreshResendStateFromServerSafe();
                return;
            }

            _resendTimer = r.CooldownSeconds;
            _canResend = false;
            ShowSnack("Код отправлен повторно", Severity.Info);
        }
        finally
        {
            _resending = false;
        }
    }


    private async Task RefreshResendStateFromServerSafe()
    {
        try
        {
            var s = await VerificationClient.GetStateAsync(_sessionId);
            if (s is null)
                return;

            _ttl = s.TtlSeconds;
            _attemptsLeft = s.AttemptsLeft;
            _resendTimer = s.CooldownSeconds;
            _canResend = s.CooldownSeconds <= 0 && !_resendBlockedForToday && !_isExpired;
        }
        catch
        {
            /* игнор */
        }
    }


    // ======== Разное ========
    private async Task Cancel()
    {
        await DraftService.ClearAllAsync(); // очистит и публичное, и пароль
        Navigation.NavigateTo(_returnUrl, forceLoad: false);
    }


    private void ShowSnack(string message, Severity severity) => Snackbar.Add(message, severity);

    public void Dispose() => StopTick();
}

<style>
    .verify-wrapper {
        height: calc(100svh - var(--appbar-h, 0px));
        box-sizing: border-box;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        background: var(--mud-palette-background);
        padding: 16px;
        overflow: clip;
    }

    @@keyframes float {
        0%, 100% {
            transform: translate(0, 0) rotate(0deg);
        }
        25% {
            transform: translate(50px, -50px) rotate(90deg);
        }
        50% {
            transform: translate(-30px, 30px) rotate(180deg);
        }
        75% {
            transform: translate(30px, 50px) rotate(270deg);
        }
    }

    .verify-container {
        position: relative;
        z-index: 1;
        width: 100%;
        max-width: 510px !important;
    }

    .verify-card {
        background: var(--mud-palette-surface);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 48px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08), 0 2px 10px rgba(0, 0, 0, 0.04);
        margin: 0 auto;
        animation: cardEntry 0.5s ease-out;
        transition: all 0.3s ease;
        width: 100%;
        box-sizing: border-box;
    }

    .verify-card.success {
        animation: successPulse 0.6s ease-out;
    }

    @@keyframes cardEntry {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @@keyframes successPulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
        100% {
            transform: scale(1);
        }
    }

    .card-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .icon-wrapper {
        width: 80px;
        height: 80px;
        margin: 0 auto 24px;
        background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-primary-darken) 100%);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: iconFloat 3s ease-in-out infinite;
    }

    .icon-wrapper .mud-icon-root {
        color: white;
        font-size: 40px;
    }

    @@keyframes iconFloat {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-5px);
        }
    }

    .title {
        font-weight: 500;
        margin-bottom: 8px;
        animation: fadeInUp 0.5s ease-out 0.1s both;
        color: var(--mud-palette-text-primary);
    }

    .subtitle {
        color: var(--mud-palette-text-secondary);
        animation: fadeInUp 0.5s ease-out 0.2s both;
        word-wrap: break-word;
    }

    .destination {
        font-weight: 500;
        font-size: 1rem;
        color: var(--mud-palette-primary);
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .code-input-container {
        margin-bottom: 32px;
        position: relative;
        animation: fadeInUp 0.5s ease-out 0.3s both;
    }

    .code-inputs {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding: 4px;
    }

    .code-input {
        width: 56px;
        height: 64px;
        border: 2px solid var(--mud-palette-divider);
        border-radius: 12px;
        text-align: center;
        font-size: 24px;
        font-weight: 400;
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
        transition: all 0.3s ease;
        outline: none;
        position: relative;
        animation: inputEntry 0.5s ease-out both;
        animation-delay: calc(0.4s + 0.05s);
        flex-shrink: 0;
    }

    .code-input.filled {
        border-color: var(--mud-palette-primary);
        background: color-mix(in srgb, var(--mud-palette-primary) 5%, var(--mud-palette-surface));
        animation: fillPulse 0.3s ease-out;
    }

    .code-input:focus {
        border-color: var(--mud-palette-primary);
        transform: scale(1.05);
        box-shadow: 0 0 0 4px rgba(var(--mud-palette-primary-rgb), 0.2);
    }

    .code-input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .code-input::placeholder {
        color: var(--mud-palette-text-secondary);
        font-size: 32px;
        line-height: 1;
    }

    @@keyframes inputEntry {
        from {
            opacity: 0;
            transform: scale(0.8) rotateX(-90deg);
        }
        to {
            opacity: 1;
            transform: scale(1) rotateX(0);
        }
    }

    @@keyframes fillPulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.1);
        }
        100% {
            transform: scale(1);
        }
    }

    .loading-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.32);
        border-radius: 12px;
        z-index: 10;
    }

    .actions {
        display: flex;
        flex-direction: column;
        gap: 16px;
        animation: fadeInUp 0.5s ease-out 0.6s both;
    }

    .submit-button {
        height: 56px;
        font-size: 20px;
        font-weight: 500;
        border-radius: 12px;
        text-transform: none;
        transition: all 0.3s ease;
    }

    .submit-button:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(var(--mud-palette-primary-rgb), 0.3);
    }

    .resend-section {
        text-align: center;
        min-height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .resend-timer {
        color: var(--mud-palette-text-secondary);
        animation: fadeIn 0.3s ease-out;
    }

    .resend-button {
        text-transform: none;
        font-weight: 500;
        animation: fadeIn 0.3s ease-out;
    }

    .cancel-button {
        text-transform: none;
        font-weight: 400;
        animation: fadeIn 0.3s ease-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .success-content {
        text-align: center;
        padding: 40px 0;
        animation: successEntry 0.5s ease-out;
    }

    @@keyframes successEntry {
        from {
            opacity: 0;
            transform: scale(0.8);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .success-icon {
        margin-bottom: 24px;
        animation: successBounce 0.6s ease-out 0.2s both;
    }

    .success-icon .mud-icon-root {
        font-size: 80px;
        color: var(--mud-palette-primary);
    }

    @@keyframes successBounce {
        0% {
            transform: scale(0) rotate(-180deg);
        }
        50% {
            transform: scale(1.2) rotate(10deg);
        }
        100% {
            transform: scale(1) rotate(0);
        }
    }

    .success-title {
        font-weight: 600;
        margin-bottom: 8px;
        animation: fadeInUp 0.5s ease-out 0.3s both;
        color: var(--mud-palette-text-primary);
    }

    .success-message {
        color: var(--mud-palette-text-secondary);
        animation: fadeInUp 0.5s ease-out 0.4s both;
    }

    @@media (max-width: 768px) {
        .verify-card {
            padding: 32px 24px;
        }

        .code-input {
            width: 52px;
            height: 60px;
        }
    }

    @@media (max-width: 600px) {
        .verify-wrapper {
            padding: 8px;
        }

        .verify-card {
            padding: 24px 16px;
            border-radius: 20px;
        }

        .card-header {
            margin-bottom: 32px;
        }

        .icon-wrapper {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
        }

        .icon-wrapper .mud-icon-root {
            font-size: 32px;
        }

        .title {
            font-size: 1.5rem;
        }

        .subtitle {
            font-size: 0.875rem;
        }

        .code-input-container {
            margin-bottom: 24px;
        }

        .code-inputs {
            gap: 8px;
            --input-size: min(48px, calc((100vw - 32px - 8px * (var(--digits, 6) - 1)) / var(--digits, 6)));
        }

        .code-input {
            width: var(--input-size, 48px);
            height: calc(var(--input-size, 48px) * 1.15);
            font-size: 20px;
            border-radius: 10px;
        }

        .code-input::placeholder {
            font-size: 24px;
        }

        .actions {
            gap: 12px;
        }

        .submit-button {
            height: 48px;
            font-size: 15px;
        }

        .success-icon .mud-icon-root {
            font-size: 64px;
        }
    }

    @@media (max-width: 480px) {
        .verify-card {
            padding: 20px 12px;
        }

        .code-inputs {
            gap: 6px;
            --input-size: min(42px, calc((100vw - 24px - 6px * (var(--digits, 6) - 1)) / var(--digits, 6)));
        }

        .code-input {
            font-size: 18px;
            border-width: 1.5px;
        }
    }

    @@media (max-width: 380px) {
        .code-inputs {
            gap: 4px;
            --input-size: min(38px, calc((100vw - 24px - 4px * (var(--digits, 6) - 1)) / var(--digits, 6)));
        }

        .code-input {
            font-size: 16px;
        }

        .code-input::placeholder {
            font-size: 20px;
        }

        .title {
            font-size: 1.25rem;
        }

        .subtitle {
            font-size: 0.8125rem;
        }
    }

    @@media (max-width: 320px) {
        .verify-card {
            padding: 16px 8px;
        }

        .code-inputs {
            gap: 3px;
            --input-size: min(34px, calc((100vw - 16px - 3px * (var(--digits, 6) - 1)) / var(--digits, 6)));
        }

        .code-input {
            font-size: 14px;
            border-radius: 8px;
        }

        .icon-wrapper {
            width: 56px;
            height: 56px;
        }

        .icon-wrapper .mud-icon-root {
            font-size: 28px;
        }
    }

    @@media (max-height: 500px) and (orientation: landscape) {
        .verify-wrapper {
            min-height: auto;
            padding: 8px;
        }

        .verify-card {
            padding: 16px 24px;
        }

        .card-header {
            margin-bottom: 16px;
        }

        .icon-wrapper {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
        }

        .icon-wrapper .mud-icon-root {
            font-size: 24px;
        }

        .code-input {
            width: 42px;
            height: 48px;
            font-size: 18px;
        }

        .actions {
            gap: 8px;
        }

        .submit-button {
            height: 40px;
            font-size: 14px;
        }
    }

    .code-inputs {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .code-inputs::-webkit-scrollbar {
        display: none;
    }

    .verify-container.mud-container-gutters {
        padding-left: 16px !important;
        padding-right: 16px !important;
    }

    .verify-card {
        max-width: clamp(440px, 56vw, 680px);
        padding: clamp(28px, 3.2vw, 48px);
    }

    @@media (min-width: 1600px) {
        .verify-card {
            max-width: 680px;
        }
    }

    @@media (min-width: 768px) {
        .code-inputs {
            gap: 12px;
        }

        .code-input {
            width: 56px;
            height: 64px;
        }
    }

    @@supports not (height: 100svh) {
        .verify-wrapper {
            height: calc(100vh - var(--appbar-h, 0px));
        }
    }

    @@media (min-height: 700px) {
        .verify-wrapper {
            align-items: flex-start;
            padding-top: clamp(24px, 10vh, 80px);
        }
    }
</style>
